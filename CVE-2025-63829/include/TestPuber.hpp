// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @file TestPuber.hpp
 * @brief FastDDS发布者测试类头文件
 * 
 * 本文件定义了TestPuber类，用于测试FastDDS发布者功能，
 * 包含QoS配置管理和消息发布功能。
 * 
 * 此文件由Python脚本自动生成，请勿手动修改。
 */

#ifndef TESTPUBER_HPP
#define TESTPUBER_HPP

#include "HelloWorldPubSubTypes.hpp"
#include "QoSManager.hpp"

#include <chrono>
#include <thread>
#include <atomic>
#include <iostream>

#include <fastdds/dds/domain/DomainParticipant.hpp>
#include <fastdds/dds/domain/DomainParticipantFactory.hpp>
#include <fastdds/dds/publisher/DataWriter.hpp>
#include <fastdds/dds/publisher/DataWriterListener.hpp>
#include <fastdds/dds/publisher/Publisher.hpp>
#include <fastdds/dds/publisher/qos/DataWriterQos.hpp>
#include <fastdds/dds/topic/TypeSupport.hpp>
#include <fastdds/rtps/common/Time_t.hpp>
#include <fastdds/dds/topic/qos/TopicQos.hpp>
#include <fastdds/dds/publisher/qos/PublisherQos.hpp>
#include <fastdds/dds/subscriber/qos/DataReaderQos.hpp>
#include <fastdds/rtps/common/Locator.hpp>
#include <fastdds/utils/IPLocator.hpp>

using namespace eprosima::fastdds::dds;
using namespace eprosima::fastdds::rtps;

/**
 * @brief FastDDS发布者测试类
 * 
 * 提供完整的发布者功能，包括：
 * - QoS配置管理
 * - 消息发布
 * - 连接状态监控
 */
class TestPuber
{
private:
    HelloWorld hello_;
    DomainParticipant* participant_;
    Publisher* publisher_;
    Topic* topic_;
    DataWriter* writer_;
    TypeSupport type_;
    QoSManager qos_manager_;

    /**
     * @brief 数据写入监听器类
     * 
     * 处理发布匹配事件
     */
    class PubListener : public DataWriterListener
    {
    public:
        PubListener()
            : matched_(0)
        {
        }

        ~PubListener() override
        {
        }

        /**
         * @brief 发布匹配状态变化回调
         * @param writer 数据写入器
         * @param info 匹配状态信息
         */
        void on_publication_matched(
                DataWriter*,
                const PublicationMatchedStatus& info) override;

        std::atomic_int matched_;
    } listener_;

public:
    /**
     * @brief 构造函数
     */
    TestPuber();

    /**
     * @brief 析构函数
     */
    virtual ~TestPuber();

    /**
     * @brief 设置QoS配置
     * @param config QoS配置
     */
    void setQoSConfig(const QoSConfig& config)
    {
        qos_manager_.setQoSConfig(config);
    }

    /**
     * @brief 获取QoS管理器
     * @return QoS管理器引用
     */
    QoSManager& getQoSManager()
    {
        return qos_manager_;
    }

    /**
     * @brief 初始化发布者
     * @return 初始化是否成功
     */
    bool init();

    /**
     * @brief 发布消息
     * @return 发布是否成功
     */
    bool publish();

    /**
     * @brief 运行发布者
     * @param samples 要发布的样本数量
     */
    void run(uint32_t samples);

    /**
     * @brief 配置发布者QoS策略
     * 
     * 设置各种QoS参数，包括：
     * - 可靠性策略
     * - Topic历史深度
     * - Topic持久性策略
     * - 分区配置
     * - 用户数据
     * - 时间相关参数
     * - 活跃性策略
     * - 所有权策略
     * - 发布模式
     * - 禁用正确认认
     */
    void configureQoS();

    /**
     * @brief 在通信过程中动态修改DataWriter的QoS策略（由Publisher发起）
     * 
     * 此方法允许Publisher在运行时动态修改可变的QoS策略，修改后会通过DDS的
     * QoS协商机制自动传播给已连接的Subscriber。
     * 
     * 可修改的策略包括：
     * - LifespanQosPolicy（生命周期）：控制数据的有效期
     * - DeadlineQosPolicy（截止时间）：控制数据更新的频率要求
     * - TransportPriorityQosPolicy（传输优先级）：影响传输优先级
     * - OwnershipStrengthQosPolicy（所有权强度）：在独占所有权模式下使用
     * 
     * 注意：以下策略一旦启用后不可修改（会返回RETCODE_IMMUTABLE_POLICY）：
     * - ReliabilityQosPolicy（可靠性）
     * - DurabilityQosPolicy（持久性）
     * - OwnershipQosPolicy（所有权种类）
     * - LivelinessQosPolicy（活跃性）
     * 
     * @param new_lifespan_sec 新的生命周期（秒），-1表示不修改
     * @param new_deadline_sec 新的截止时间（秒），-1表示不修改
     * @param new_transport_priority 新的传输优先级，-1表示不修改
     * @return 是否修改成功
     */
    bool updateQoSDynamically(int32_t new_lifespan_sec = -1, 
                              int32_t new_deadline_sec = -1,
                              int32_t new_transport_priority = -1);
};

/**
 * @brief 辅助函数：创建Duration_t对象
 * @param seconds 秒数
 * @param nanoseconds 纳秒数
 * @return Duration_t对象
 */
Duration_t createDuration(int32_t seconds, uint32_t nanoseconds);

#endif // TESTPUBER_HPP 