#!/bin/bash

# Cyclone DDS Security Configuration Script
# Configure according to https://cyclonedds.io/docs/cyclonedds/latest/security/example_configuration.html

set -e  # Exit immediately on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CERTS_DIR="${SCRIPT_DIR}/certs"
ETC_DIR="${SCRIPT_DIR}/etc"

# Create necessary directories
mkdir -p "${CERTS_DIR}"
mkdir -p "${ETC_DIR}"

echo "=== Starting Cyclone DDS Security Configuration ==="
echo "Certificate directory: ${CERTS_DIR}"
echo "Configuration file directory: ${ETC_DIR}"
echo ""

# ========================================
# Step 1: Create Identity CA (Identity CA)
# ========================================
echo "Step 1: Creating Identity CA..."
openssl genrsa -out "${CERTS_DIR}/example_id_ca_priv_key.pem" 2048
openssl req -x509 -key "${CERTS_DIR}/example_id_ca_priv_key.pem" \
    -out "${CERTS_DIR}/example_id_ca_cert.pem" -days 3 \
    -subj "/C=NL/ST=OV/L=Locality Name/OU=Example OU/O=Example ID CA Organization/CN=Example ID CA/emailAddress=authority@example.com"

# ========================================
# Step 2: Create Permissions CA (Permissions CA)
# ========================================
echo "Step 2: Creating Permissions CA..."
openssl genrsa -out "${CERTS_DIR}/example_perm_ca_priv_key.pem" 2048
openssl req -x509 -key "${CERTS_DIR}/example_perm_ca_priv_key.pem" \
    -out "${CERTS_DIR}/example_perm_ca_cert.pem" -days 3 \
    -subj "/C=NL/ST=OV/L=Locality Name/OU=Example OU/O=Example CA Organization/CN=Example Permissions CA/emailAddress=authority@example.com"

# ========================================
# Step 3: Create Publisher (Alice) Identity Certificate
# ========================================
echo "Step 3: Creating Publisher (Alice) Identity Certificate..."
openssl genrsa -out "${CERTS_DIR}/example_publisher_priv_key.pem" 2048
openssl req -new -key "${CERTS_DIR}/example_publisher_priv_key.pem" \
    -out "${CERTS_DIR}/example_publisher.csr" \
    -subj "/C=NL/ST=OV/L=Locality Name/OU=Organizational Unit Name/O=Example Organization/CN=Publisher Example/emailAddress=publisher@example.com"
openssl x509 -req -CA "${CERTS_DIR}/example_id_ca_cert.pem" \
    -CAkey "${CERTS_DIR}/example_id_ca_priv_key.pem" \
    -CAcreateserial -days 3 \
    -in "${CERTS_DIR}/example_publisher.csr" \
    -out "${CERTS_DIR}/example_publisher_cert.pem"

# ========================================
# Step 4: Create Subscriber (Bob) Identity Certificate
# ========================================
echo "Step 4: Creating Subscriber (Bob) Identity Certificate..."
openssl genrsa -out "${CERTS_DIR}/example_subscriber_priv_key.pem" 2048
openssl req -new -key "${CERTS_DIR}/example_subscriber_priv_key.pem" \
    -out "${CERTS_DIR}/example_subscriber.csr" \
    -subj "/C=NL/ST=OV/L=Locality Name/OU=Organizational Unit Name/O=Example Organization/CN=Subscriber Example/emailAddress=subscriber@example.com"
openssl x509 -req -CA "${CERTS_DIR}/example_id_ca_cert.pem" \
    -CAkey "${CERTS_DIR}/example_id_ca_priv_key.pem" \
    -CAcreateserial -days 3 \
    -in "${CERTS_DIR}/example_subscriber.csr" \
    -out "${CERTS_DIR}/example_subscriber_cert.pem"

# ========================================
# Step 5: Create Governance Document
# ========================================
echo "Step 5: Creating Governance Document..."
cat > "${ETC_DIR}/example_governance.xml" << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<dds xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://www.omg.org/spec/DDS-SECURITY/20170901/omg_shared_ca_governance.xsd">
  <domain_access_rules>
    <domain_rule>
      <domains>
        <id_range>
          <min>0</min>
          <max>230</max>
        </id_range>
      </domains>
      <allow_unauthenticated_participants>false</allow_unauthenticated_participants>
      <enable_join_access_control>true</enable_join_access_control>
      <discovery_protection_kind>NONE</discovery_protection_kind>
      <liveliness_protection_kind>NONE</liveliness_protection_kind>
      <rtps_protection_kind>NONE</rtps_protection_kind>
      <topic_access_rules>
        <topic_rule>
          <topic_expression>*</topic_expression>
          <enable_discovery_protection>true</enable_discovery_protection>
          <enable_liveliness_protection>true</enable_liveliness_protection>
          <enable_read_access_control>true</enable_read_access_control>
          <enable_write_access_control>true</enable_write_access_control>
          <metadata_protection_kind>SIGN</metadata_protection_kind>
          <data_protection_kind>ENCRYPT</data_protection_kind>
        </topic_rule>
      </topic_access_rules>
    </domain_rule>
  </domain_access_rules>
</dds>
EOF

# Sign Governance document
echo "Signing Governance document..."
openssl smime -sign -in "${ETC_DIR}/example_governance.xml" -text \
    -out "${ETC_DIR}/example_governance.p7s" \
    -signer "${CERTS_DIR}/example_perm_ca_cert.pem" \
    -inkey "${CERTS_DIR}/example_perm_ca_priv_key.pem"

# ========================================
# Step 6: Create Publisher Permissions Document
# ========================================
echo "Step 6: Creating Publisher Permissions Document..."
cat > "${ETC_DIR}/example_publisher_permissions.xml" << 'EOF'
<?xml version="1.0" encoding="utf-8" ?>
<dds xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:noNamespaceSchemaLocation="https://www.omg.org/spec/DDS-SECURITY/20170901/omg_shared_ca_permissions.xsd">
  <permissions>
    <grant name="default_permissions">
      <subject_name>emailAddress=publisher@example.com,CN=Publisher Example,O=Example Organization,OU=Organizational Unit Name,L=Locality Name,ST=OV,C=NL</subject_name>
      <validity>
        <!-- Format is CCYY-MM-DDThh:mm:ss[Z|(+|-)hh:mm] in GMT -->
        <not_before>2020-01-01T01:00:00</not_before>
        <not_after>2120-01-01T01:00:00</not_after>
      </validity>
      <allow_rule>
        <domains>
          <id_range>
            <min>0</min>
            <max>230</max>
          </id_range>
        </domains>
        <publish>
          <topics>
            <topic>*</topic>
          </topics>
          <partitions>
            <partition>*</partition>
          </partitions>
        </publish>
        <subscribe>
          <topics>
            <topic>*</topic>
          </topics>
          <partitions>
            <partition>*</partition>
          </partitions>
        </subscribe>
      </allow_rule>
      <default>DENY</default>
    </grant>
  </permissions>
</dds>
EOF

# Sign Publisher Permissions document
echo "Signing Publisher Permissions document..."
openssl smime -sign -in "${ETC_DIR}/example_publisher_permissions.xml" -text \
    -out "${ETC_DIR}/example_publisher_permissions.p7s" \
    -signer "${CERTS_DIR}/example_perm_ca_cert.pem" \
    -inkey "${CERTS_DIR}/example_perm_ca_priv_key.pem"

# ========================================
# Step 7: Create Subscriber Permissions Document
# ========================================
echo "Step 7: Creating Subscriber Permissions Document..."
cat > "${ETC_DIR}/example_subscriber_permissions.xml" << 'EOF'
<?xml version="1.0" encoding="utf-8" ?>
<dds xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:noNamespaceSchemaLocation="https://www.omg.org/spec/DDS-SECURITY/20170901/omg_shared_ca_permissions.xsd">
  <permissions>
    <grant name="default_permissions">
      <subject_name>emailAddress=subscriber@example.com,CN=Subscriber Example,O=Example Organization,OU=Organizational Unit Name,L=Locality Name,ST=OV,C=NL</subject_name>
      <validity>
        <!-- Format is CCYY-MM-DDThh:mm:ss[Z|(+|-)hh:mm] in GMT -->
        <not_before>2020-01-01T01:00:00</not_before>
        <not_after>2120-01-01T01:00:00</not_after>
      </validity>
      <allow_rule>
        <domains>
          <id_range>
            <min>0</min>
            <max>230</max>
          </id_range>
        </domains>
        <publish>
          <topics>
            <topic>*</topic>
          </topics>
          <partitions>
            <partition>*</partition>
          </partitions>
        </publish>
        <subscribe>
          <topics>
            <topic>*</topic>
          </topics>
          <partitions>
            <partition>*</partition>
          </partitions>
        </subscribe>
      </allow_rule>
      <default>DENY</default>
    </grant>
  </permissions>
</dds>
EOF

# Sign Subscriber Permissions document
echo "Signing Subscriber Permissions document..."
openssl smime -sign -in "${ETC_DIR}/example_subscriber_permissions.xml" -text \
    -out "${ETC_DIR}/example_subscriber_permissions.p7s" \
    -signer "${CERTS_DIR}/example_perm_ca_cert.pem" \
    -inkey "${CERTS_DIR}/example_perm_ca_priv_key.pem"

# Clean up temporary files
echo "Cleaning up temporary files..."
rm -f "${CERTS_DIR}/example_publisher.csr"
rm -f "${CERTS_DIR}/example_subscriber.csr"
rm -f "${CERTS_DIR}/example_id_ca_priv_key.pem.srl"
rm -f "${CERTS_DIR}/example_id_ca_cert.pem.srl"

echo ""
echo "=== Security Configuration Complete! ==="
echo ""
echo "Generated files:"
echo "Certificate directory (${CERTS_DIR}):"
ls -lh "${CERTS_DIR}"/*.pem
echo ""
echo "Configuration file directory (${ETC_DIR}):"
ls -lh "${ETC_DIR}"/*.xml "${ETC_DIR}"/*.p7s
echo ""
echo "Next steps:"
echo "1. Certificate paths in publisher.c and subscriber.c have been updated"
echo "2. Compile and run the programs for testing"
