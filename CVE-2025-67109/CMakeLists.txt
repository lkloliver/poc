#
# CycloneDDS Encrypted Communication Test Case
# Publisher/Subscriber test using expired certificates
#
cmake_minimum_required(VERSION 3.16)
project(CycloneDDS_Security_Test LANGUAGES C CXX)

# Find CycloneDDS package
# Prefer to use find_package for installed version
find_package(CycloneDDS QUIET)

if(NOT CycloneDDS_FOUND)
    # If installed version not found, try using add_subdirectory
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/../cyclonedds/CMakeLists.txt")
        message(STATUS "Installed CycloneDDS not found, attempting to use add_subdirectory method")
        message(WARNING "Note: Using add_subdirectory may require building CycloneDDS first")
        message(WARNING "Recommendation: Build and install CycloneDDS first, or use an installed version")
        
        # Check if there is a built CycloneDDS
        if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/../cyclonedds/build")
            message(STATUS "Found CycloneDDS build directory, attempting to use")
            set(CycloneDDS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../cyclonedds/build")
            find_package(CycloneDDS QUIET)
        endif()
        
        if(NOT CycloneDDS_FOUND)
            message(FATAL_ERROR 
                "CycloneDDS not found.\n"
                "Please choose one of the following methods:\n"
                "1. Install CycloneDDS: cd ../cyclonedds && mkdir build && cd build && cmake .. && make && sudo make install\n"
                "2. Or set CycloneDDS_DIR to point to CycloneDDS build directory")
        endif()
    else()
        message(FATAL_ERROR "CycloneDDS not found. Please ensure CycloneDDS is built or installed.")
    endif()
endif()

# Determine the target name to use
if(TARGET CycloneDDS::ddsc)
    set(DDSC_TARGET CycloneDDS::ddsc)
else()
    message(FATAL_ERROR "CycloneDDS::ddsc target not found")
endif()

# Find OpenSSL (for certificate generation)
find_package(OpenSSL REQUIRED)

# Generate IDL data type library
idlc_generate(TARGET TestData_lib FILES "TestData.idl" WARNINGS no-implicit-extensibility)



# Create publisher executable
add_executable(SecurityPublisher publisher.c)
target_link_libraries(SecurityPublisher TestData_lib ${DDSC_TARGET})

# Create subscriber executable
add_executable(SecuritySubscriber subscriber.c)
target_link_libraries(SecuritySubscriber TestData_lib ${DDSC_TARGET})

# Set output directory
set_target_properties(SecurityPublisher SecuritySubscriber
    PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)



