#include "dds/dds.h"
#include "TestData.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int main(int argc, char **argv)
{
    dds_entity_t participant;
    dds_entity_t topic;
    dds_entity_t writer;
    dds_return_t rc;
    TestData_Message msg;
    uint32_t status = 0;
    (void)argc;
    (void)argv;

    // Get current working directory, construct absolute paths for certificates and configuration files
    char cwd[1024];
    if (getcwd(cwd, sizeof(cwd)) == NULL) {
        fprintf(stderr, "Error: Unable to get current working directory\n");
        return EXIT_FAILURE;
    }
    
    // Check if in build/bin directory, if so go up two levels to project root
    char certs_dir[2048];
    char etc_dir[2048];
    char certs_dir_abs[2048];
    char etc_dir_abs[2048];
    
    if (strstr(cwd, "/build/bin") != NULL || strstr(cwd, "/build") != NULL) {
        // In build directory, go up two levels to project root
        snprintf(certs_dir, sizeof(certs_dir), "%s/../certs", cwd);
        snprintf(etc_dir, sizeof(etc_dir), "%s/../etc", cwd);
    } else {
        // In project root directory
        snprintf(certs_dir, sizeof(certs_dir), "%s/certs", cwd);
        snprintf(etc_dir, sizeof(etc_dir), "%s/etc", cwd);
    }
    
    // Convert to absolute paths
    if (realpath(certs_dir, certs_dir_abs) == NULL) {
        fprintf(stderr, "Error: Unable to resolve certificate directory path\n");
        return EXIT_FAILURE;
    }
    if (realpath(etc_dir, etc_dir_abs) == NULL) {
        fprintf(stderr, "Error: Unable to resolve configuration directory path\n");
        return EXIT_FAILURE;
    }
    
    // Set CycloneDDS configuration, enable security encryption
    char config[4096];
    snprintf(config, sizeof(config),
        "<CycloneDDS>"
        "  <Domain id=\"any\">"
        "    <Discovery>"
        "      <ExternalDomainId>0</ExternalDomainId>"
        "    </Discovery>"
        "    <Security>"
        "      <Authentication>"
        "        <Library initFunction=\"init_authentication\" finalizeFunction=\"finalize_authentication\" path=\"dds_security_auth\"/>"
        "        <IdentityCertificate>file:%s/example_publisher_cert.pem</IdentityCertificate>"
        "        <PrivateKey>file:%s/example_publisher_priv_key.pem</PrivateKey>"
        "        <IdentityCA>file:%s/example_id_ca_cert.pem</IdentityCA>"
        "      </Authentication>"
        "      <Cryptographic>"
        "        <Library initFunction=\"init_crypto\" finalizeFunction=\"finalize_crypto\" path=\"dds_security_crypto\"/>"
        "      </Cryptographic>"
        "      <AccessControl>"
        "        <Library initFunction=\"init_access_control\" finalizeFunction=\"finalize_access_control\" path=\"dds_security_ac\"/>"
        "        <PermissionsCA>file:%s/example_perm_ca_cert.pem</PermissionsCA>"
        "        <Governance>file:%s/example_governance.p7s</Governance>"
        "        <Permissions>file:%s/example_publisher_permissions.p7s</Permissions>"
        "      </AccessControl>"
        "    </Security>"
        "  </Domain>"
        "</CycloneDDS>",
        certs_dir_abs, certs_dir_abs, certs_dir_abs,
        certs_dir_abs, etc_dir_abs, etc_dir_abs);

    // Set environment variable
    setenv("CYCLONEDDS_URI", config, 1);

    printf("=== [Publisher] Creating participant (using DDS security configuration)...\n");
    fflush(stdout);

    /* Create participant */
    participant = dds_create_participant(DDS_DOMAIN_DEFAULT, NULL, NULL);
    if (participant < 0)
    {
        fprintf(stderr, "Error: dds_create_participant: %s\n", dds_strretcode(-participant));
        return EXIT_FAILURE;
    }

    printf("=== [Publisher] Creating topic...\n");
    fflush(stdout);

    /* Create topic */
    topic = dds_create_topic(
        participant, &TestData_Message_desc, "TestData_Message", NULL, NULL);
    if (topic < 0)
    {
        fprintf(stderr, "Error: dds_create_topic: %s\n", dds_strretcode(-topic));
        dds_delete(participant);
        return EXIT_FAILURE;
    }

    printf("=== [Publisher] Creating writer...\n");
    fflush(stdout);

    /* Create writer */
    writer = dds_create_writer(participant, topic, NULL, NULL);
    if (writer < 0)
    {
        fprintf(stderr, "Error: dds_create_writer: %s\n", dds_strretcode(-writer));
        dds_delete(participant);
        return EXIT_FAILURE;
    }

    printf("=== [Publisher] Waiting to discover subscriber...\n");
    fflush(stdout);

    rc = dds_set_status_mask(writer, DDS_PUBLICATION_MATCHED_STATUS);
    if (rc != DDS_RETCODE_OK)
    {
        fprintf(stderr, "Error: dds_set_status_mask: %s\n", dds_strretcode(-rc));
        dds_delete(participant);
        return EXIT_FAILURE;
    }

    int wait_count = 0;
    while (!(status & DDS_PUBLICATION_MATCHED_STATUS))
    {
        rc = dds_get_status_changes(writer, &status);
        if (rc != DDS_RETCODE_OK)
        {
            fprintf(stderr, "Error: dds_get_status_changes: %s\n", dds_strretcode(-rc));
            dds_delete(participant);
            return EXIT_FAILURE;
        }

        wait_count++;
        if (wait_count > 250) // Wait up to 5 seconds
        {
            printf("=== [Publisher] Warning: Subscriber not discovered, continuing to send message...\n");
            break;
        }

        /* Poll wait */
        dds_sleepfor(DDS_MSECS(20));
    }

    /* Create message to write */
    msg.id = 1;
    msg.content = "Hello from Publisher with Expired Certificate!";

    printf("=== [Publisher] Sending message: ID=%"PRId32", Content=%s\n", msg.id, msg.content);
    fflush(stdout);

    rc = dds_write(writer, &msg);
    if (rc != DDS_RETCODE_OK)
    {
        fprintf(stderr, "Error: dds_write: %s\n", dds_strretcode(-rc));
        dds_delete(participant);
        return EXIT_FAILURE;
    }

    printf("=== [Publisher] Message sent\n");
    fflush(stdout);

    /* Wait for a period to ensure message is received */
    dds_sleepfor(DDS_SECS(1));

    /* Deleting participant will recursively delete all its child entities */
    rc = dds_delete(participant);
    if (rc != DDS_RETCODE_OK)
    {
        fprintf(stderr, "Error: dds_delete: %s\n", dds_strretcode(-rc));
        return EXIT_FAILURE;
    }

    printf("=== [Publisher] Exiting\n");
    return EXIT_SUCCESS;
}


