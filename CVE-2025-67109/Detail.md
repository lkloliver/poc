# CycloneDDS Certificate Time Validation Vulnerability

## Summary

CycloneDDS uses system time (which can be manipulated) instead of a trusted time source for certificate validation, allowing attackers to bypass certificate expiration checks by modifying the system clock.

## Vulnerability Description

During certificate validation, CycloneDDS relies on the system's wall clock time (`CLOCK_REALTIME`) obtained through standard system calls. This time source can be modified by users with appropriate privileges or through system-level attacks, enabling an attacker to manipulate the system clock to make expired certificates appear valid or future certificates appear current.

## Affected Code Locations

### 1. Time Source (`/src/ddsrt/src/time/posix/time.c#L28`)

```c
dds_time_t dds_time(void)
{
  struct timespec ts;
  (void)clock_gettime(CLOCK_REALTIME, &ts);  // Line 28: Uses manipulatable system time
  return (ts.tv_sec * DDS_NSECS_IN_SEC) + ts.tv_nsec;
}
```

The `dds_time()` function retrieves the current time using `clock_gettime(CLOCK_REALTIME, &ts)`, which returns the system's real-time clock. This clock can be modified by users with appropriate permissions (e.g., root access, or through NTP manipulation).

### 2. Certificate Expiry Check (`/src/security/builtin_plugins/authentication/src/auth_utils.c#L84`)

```c
dds_time_t get_certificate_expiry(const X509 *cert)
{
  // ...
  const dds_time_t now = dds_time();  // Line 84: Uses manipulatable time source
  // ...
}
```

The `get_certificate_expiry()` function calls `dds_time()` to obtain the current time for comparing against certificate validity periods.

### 3. Certificate Validation (`/src/security/builtin_plugins/authentication/src/auth_utils.c#L243-L248`)

```c
DDS_Security_ValidationResult_t check_certificate_expiry(const X509 *cert, DDS_Security_SecurityException *ex)
{
  // Line 243: X509_cmp_current_time also relies on system time
  if (X509_cmp_current_time(X509_get0_notBefore(cert)) == 0)
  {
    // ...
  }
  // Line 248: Expiry check uses system time
  if (X509_cmp_current_time(X509_get0_notAfter(cert)) == 0)
  {
    // ...
  }
}
```

The OpenSSL function `X509_cmp_current_time()` internally uses the system time, compounding the vulnerability.

## Impact

- **Bypass Certificate Expiration**: An attacker with system access can set the system clock backwards to make expired certificates appear valid.
- **Authentication Bypass**: Expired or revoked certificates can be accepted by manipulating system time.
- **Security Policy Violation**: DDS Security's certificate-based authentication and access control mechanisms can be circumvented.

## Remediation Recommendations

1. Use monotonic clocks (`CLOCK_MONOTONIC`) for internal timing where appropriate, though this doesn't solve certificate validation issues.
2. Implement trusted time sources such as:
   - Secure NTP with authentication
   - Hardware security modules (HSM) with trusted time
   - Time attestation from trusted external services
3. Add time skew detection to identify significant discrepancies between system time and trusted time sources.
4. Consider implementing certificate revocation checks that don't solely rely on expiration dates.
