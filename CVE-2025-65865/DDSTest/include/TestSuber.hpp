// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @file TestSuber.hpp
 * @brief FastDDS订阅者测试类头文件
 * 
 * 本文件定义了TestSuber类，用于测试FastDDS订阅者功能，
 * 包含QoS配置管理和消息接收功能。
 * 
 * 此文件由Python脚本自动生成，请勿手动修改。
 */

#ifndef TESTSUBER_HPP
#define TESTSUBER_HPP

#include "HelloWorldPubSubTypes.hpp"
#include "QoSManager.hpp"

#include <chrono>
#include <thread>
#include <atomic>
#include <iostream>

#include <fastdds/dds/domain/DomainParticipant.hpp>
#include <fastdds/dds/domain/DomainParticipantFactory.hpp>
#include <fastdds/dds/subscriber/DataReader.hpp>
#include <fastdds/dds/subscriber/DataReaderListener.hpp>
#include <fastdds/dds/subscriber/qos/DataReaderQos.hpp>
#include <fastdds/dds/subscriber/SampleInfo.hpp>
#include <fastdds/dds/subscriber/Subscriber.hpp>
#include <fastdds/dds/topic/TypeSupport.hpp>
#include <fastdds/rtps/common/Time_t.hpp>
#include <fastdds/dds/topic/qos/TopicQos.hpp>
#include <fastdds/dds/subscriber/qos/SubscriberQos.hpp>

using namespace eprosima::fastdds::dds;
using namespace eprosima::fastdds::rtps;

/**
 * @brief FastDDS订阅者测试类
 * 
 * 提供完整的订阅者功能，包括：
 * - QoS配置管理
 * - 消息接收和处理
 * - 连接状态监控
 */
class TestSuber
{
private:
    DomainParticipant *participant_;
    Subscriber *subscriber_;
    DataReader *reader_;
    Topic *topic_;
    TypeSupport type_;
    QoSManager qos_manager_;

    /**
     * @brief 数据读取监听器类
     * 
     * 处理订阅匹配和数据可用性事件
     */
    class SubListener : public DataReaderListener
    {
    public:
        SubListener()
            : samples_(0), matched_(0)
        {
        }

        ~SubListener() override
        {
        }

        /**
         * @brief 订阅匹配状态变化回调
         * @param reader 数据读取器
         * @param info 匹配状态信息
         */
        void on_subscription_matched(
            DataReader *,
            const SubscriptionMatchedStatus &info) override;

        /**
         * @brief 数据可用性回调
         * @param reader 数据读取器
         */
        void on_data_available(
            DataReader *reader) override;

        HelloWorld hello_;
        std::atomic_int samples_;
        std::atomic_int matched_;
    } listener_;

public:
    /**
     * @brief 构造函数
     */
    TestSuber();

    /**
     * @brief 析构函数
     */
    virtual ~TestSuber();

    /**
     * @brief 设置QoS配置
     * @param config QoS配置
     */
    void setQoSConfig(const QoSConfig& config)
    {
        qos_manager_.setQoSConfig(config);
    }

    /**
     * @brief 获取QoS管理器
     * @return QoS管理器引用
     */
    QoSManager& getQoSManager()
    {
        return qos_manager_;
    }

    /**
     * @brief 初始化订阅者
     * @return 初始化是否成功
     */
    bool init();

    /**
     * @brief 运行订阅者
     * @param samples 要接收的样本数量
     */
    void run(uint32_t samples);

    /**
     * @brief 配置订阅者QoS策略
     * 
     * 设置各种QoS参数，包括：
     * - 可靠性策略
     * - Topic历史深度
     * - Topic持久性策略
     * - 分区配置
     * - 用户数据
     * - 时间相关参数
     * - 活跃性策略
     * - 所有权策略
     * - 基于时间的过滤
     * - 禁用正确认认
     */
    void configureQoS();
};

/**
 * @brief 辅助函数：创建Duration_t对象
 * @param seconds 秒数
 * @param nanoseconds 纳秒数
 * @return Duration_t对象
 */
Duration_t createDuration(int32_t seconds, uint32_t nanoseconds);

#endif // TESTSUBER_HPP 